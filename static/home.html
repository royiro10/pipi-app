<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipi Home Page</title>
    <link rel="stylesheet" href="/home.css">
</head>

<body>
    <header>
        <h1>Pipi Home Page</h1>
    </header>
    <main>
        <section id="qr-section" class="qr-section">
            <h2>QR Code</h2>
            <button id="qr-button" disabled>Fetch QR Code</button>
            <img id="qr-image" alt="QR Code" style="display: none;">
        </section>

        <h2>Services Status</h2>
        <section class="services-status">
            <ul id="service-list"></ul>
        </section>

        <h2>Server Logs</h2>
        <section class="server-logs">
            <div id="log-container"></div>
        </section>
    </main>
    <script>
        const LOGS_ENDPOINT = `/api/logs`
        const SERVICES_STATUS_ENDPOINT = `/api/services-status`
        const QR_ENDPOINT = `/api/qr`

        const serviceList = document.getElementById("service-list");
        const logContainer = document.getElementById("log-container");
        const qrSection = document.getElementById("qr-section")
        const qrButton = document.getElementById("qr-button");
        const qrImage = document.getElementById("qr-image");

        function updateServiceList(services) {
            let isServiceBDown = false;
            serviceList.innerHTML = ""; // Clear existing list items


            for (const service of services) {
                const listItem = document.createElement("li");
                listItem.textContent = `${service.name}: ${service.status}`;
                listItem.className = (`service-status ${service.status}`)
                serviceList.appendChild(listItem);

                if (service.name === "Whatsapp Client" && service.status.toLowerCase() !== "ok") {
                    isServiceBDown = true;
                }
            }
            qrButton.disabled = !isServiceBDown;
            qrSection.style.display = qrButton.disabled ? 'none' : 'inline-block';
        }

        setInterval(() => {
            fetch(SERVICES_STATUS_ENDPOINT)
                .then(response => response.json())
                .then(data => updateServiceList(data))
                .catch(error => console.error("Error fetching service data:", error));
        }, 3 * 1000)


        const eventSource = new EventSource(LOGS_ENDPOINT);

        eventSource.onmessage = function (event) {
            const logMessage = JSON.parse(event.data);
            const logPre = document.createElement("pre");
            logPre.textContent = `${logMessage.timestamp} - ${logMessage.message}`;
            logPre.className = "wrap-logs"

            logContainer.appendChild(logPre); // Append to display new messages at the bottom
        };

        eventSource.onerror = function (error) {
            console.error("Error connecting to SSE:", error);
        };

        qrButton.addEventListener("click", function () {
            qrButton.disabled = true; // Disable button to prevent multiple clicks

            fetch(QR_ENDPOINT)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error fetching QR code: ${response.statusText}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    qrImage.src = url;
                    qrImage.style.display = "block";
                })
                .catch(error => {
                    console.error("Error fetching QR code:", error);
                    alert("Failed to fetch QR code.");
                })
                .finally(() => {
                    qrButton.disabled = false;
                });
        });
    </script>
</body>

</html>