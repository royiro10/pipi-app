<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipi Home Page</title>
    <link rel="stylesheet" href="/home.css">
</head>

<body>
    <header>
        <h1>Pipi Home Page</h1>
    </header>
    <main>
        <section id="qr-section" class="qr-section">
            <h2>QR Code</h2>
            <button id="qr-button" disabled>Fetch QR Code</button>
            <img id="qr-image" alt="QR Code" style="display: none;">
        </section>

        <h2>Services Status</h2>
        <section class="services-status">
            <ul id="service-list"></ul>
        </section>

        <section class="allowed-strings">
            <h2>Allowed Strings</h2>
            <ul id="allowed-list"></ul>
            <p>
                <input type="text" id="new-string" placeholder="Enter new allowed string">
                <button id="add-button">Add String</button>
            </p>
        </section>

        <h2>Server Logs</h2>
        <section class="server-logs">
            <div id="log-container"></div>
        </section>
    </main>
    <script>
        const LOGS_ENDPOINT = `/api/logs`
        const SERVICES_STATUS_ENDPOINT = `/api/services-status`
        const QR_ENDPOINT = `/api/qr`
        const BOUNCER_ENDPOINT = `/api/bouncer`

        const serviceList = document.getElementById("service-list");
        const logContainer = document.getElementById("log-container");
        const qrSection = document.getElementById("qr-section")
        const qrButton = document.getElementById("qr-button");
        const qrImage = document.getElementById("qr-image");

        const allowedList = document.getElementById("allowed-list");
        const newStringInput = document.getElementById("new-string");
        const addButton = document.getElementById("add-button");

        function updateServiceList(services) {
            let isServiceBDown = false;
            serviceList.innerHTML = ""; // Clear existing list items


            for (const service of services) {
                const listItem = document.createElement("li");
                listItem.textContent = `${service.name}: ${service.status}`;
                listItem.className = (`service-status ${service.status}`)
                serviceList.appendChild(listItem);

                if (service.name === "Whatsapp Client" && service.status.toLowerCase() !== "ok") {
                    isServiceBDown = true;
                }
            }

            qrButton.disabled = !isServiceBDown;
            qrSection.style.display = qrButton.disabled ? 'none' : 'inline-block';
        }

        setInterval(() => {
            fetch(SERVICES_STATUS_ENDPOINT)
                .then(response => response.json())
                .then(data => updateServiceList(data))
                .catch(error => console.error("Error fetching service data:", error));
        }, 3 * 1000)


        updateMembersList()

        function addMember() {
            const newString = newStringInput.value.trim();
            if (!newString) {
                alert("Please enter a new string.");
                return;
            }

            console.log(Array.from(allowedList.querySelectorAll("li").values()))

            return fetch(BOUNCER_ENDPOINT, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify([...Array.from(allowedList.querySelectorAll("li").values()).map(li => li.textContent), newString])
            })
                .then(response => response.json())
                .catch(error => console.error("Error adding new string:", error));
        };

        async function updateMembersList() {
            newStringInput.value = "";
            allowedList.innerHTML = "";
            members = await fetch(BOUNCER_ENDPOINT)
                .then(response => response.json())

            for (const allowedString of members) {
                const listItem = document.createElement("li");
                const removeButton = document.createElement("button");
                removeButton.textContent = allowedString;
                removeButton.onclick = async () => {
                    await deleteMember(allowedString)
                    await updateMembersList()
                };
                listItem.appendChild(removeButton);
                allowedList.appendChild(listItem);
            }
        }

        function deleteMember(stringToRemove) {
            console.log(JSON.stringify({ member: stringToRemove }))
            return fetch(`/api/bouncer`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ member: stringToRemove })
            })
                .then(response => response.json())
                .catch(error => console.error("Error removing string:", error));
        }

        addButton.onclick = async () => {
            await addMember()
            await updateMembersList()
        }


        const eventSource = new EventSource(LOGS_ENDPOINT);

        eventSource.onmessage = function (event) {
            const logMessage = JSON.parse(event.data);
            const logPre = document.createElement("pre");
            logPre.textContent = `${logMessage.timestamp} - ${logMessage.message}`;
            logPre.className = "wrap-logs"

            logContainer.appendChild(logPre); // Append to display new messages at the bottom
        };

        eventSource.onerror = function (error) {
            console.error("Error connecting to SSE:", error);
        };

        qrButton.addEventListener("click", function () {
            qrButton.disabled = true; // Disable button to prevent multiple clicks

            fetch(QR_ENDPOINT)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error fetching QR code: ${response.statusText}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    qrImage.src = url;
                    qrImage.style.display = "block";
                })
                .catch(error => {
                    console.error("Error fetching QR code:", error);
                    alert("Failed to fetch QR code.");
                })
                .finally(() => {
                    qrButton.disabled = false;
                });
        });
    </script>
</body>

</html>